{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'produtos/css/listar_produ.css' %}">
    <title>Listar produtos</title>
</head>
<body>

  {% include 'navbar.html' %}

    <div class="container">
        <h1>Produtos</h1><br><br><br>


        <div class="search-form">
          <form action="{% url 'FiltrarProdu' %}" method="get">
              <div class="search-container">
                  <input type="text" name="search" placeholder="Pesquisar" id="barra_de_pesquisa" class="search-input" required>
                  <input type="submit" value="Filtrar" class="search-button" id="botao_pesquisa">
              </div>
          </form>
          {% if filtro %}
          <a href="{% url 'VoltarProdutos'%}"><input type="submit" value="Desfazer filtro" class="search-button2"></a>
          {%endif%}
      </div>
      <br><br>
      <div class="tabela-scroll">
        <table class="table-produtos">
          <colgroup>
            <col style="width: 20%">
            <col style="width: 18%">
            <col style="width: 18%">
            <col style="width: 18%">
            <col style="width: 18%">
            <col style="width: 26%">
          </colgroup>
          <thead class="thead-light">
            <tr>
              <th scope="col">Nome</th>
              <th scope="col">Código de barras</th>
              <th scope="col">Preço</th>
              <th scope="col">Tipo</th>
              <th scope="col">Situação</th>
              <th scope="col">Editar</th>
            </tr>
          </thead>
        </table>
        <div class="tabela-corpo">
          <table class="table table-hover">
            <colgroup>
              <col style="width: 20%">
              <col style="width: 18%">
              <col style="width: 18%">
              <col style="width: 18%">
              <col style="width: 18%">
              <col style="width: 26%">
            </colgroup>
          <tbody>
              {% for produto in produto %}
            <tr>
              {% if produto.nome|length > 29%}
              <td>{{produto.nome|slice:":30"}}...</td>
              {%else%}
              <td>{{produto.nome}}</td>
              {%endif%}
              <td>{{ produto.cod_barras|slice:":3" }}-{{ produto.cod_barras|slice:"3:9" }}-{{ produto.cod_barras|slice:"9:" }}</td>
              <td>R$ {{produto.preco}}</td>
              <td>{{produto.tipo}}</td>
              <td><span
                class="situation-dot {% if produto.situacao == 'Ativo' %}active{% else %}inactive{% endif %}">
              </span> {{produto.situacao}}</td>
              <td><a href="{% url 'EditarProdu' id=produto.id%}"><img src="https://thumbs2.imgbox.com/ce/70/GXNBIaJY_t.png"/></a></td>
            </tr>
            {%endfor%}

          </tbody>
        </table>
        </div>
      </div>
        <br><br>
          <button type="button" onclick="exibirModalAdicionar()">Adicionar Produto +</button>

          <nav aria-label="Page navigation" class="paginator">
            <ul class="pagination-justify-content-center">
              {% if produto.has_previous %}
                <a class="page-link" href="?page=1">Primeira</a>
                <a class="page-link" href="?page={{ produto.previous_page_number }}">Anterior</a>
              {% endif %}
          
              {% for num in produto.paginator.page_range %}
                {% if num == produto.number %}
                    <span class="page-link"  id="pagina_atual">{{ num }}</span>
                  
                {% else %}
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                {% endif %}
              {% endfor %}
          
              {% if produto.has_next %}
                <a class="page-link" href="?page={{ produto.next_page_number }}">>></a>
                <a class="page-link" href="?page={{ produto.paginator.num_pages }}">Última</a>
              {% endif %}
            </ul>
          </nav>
          
    </div>
    <div id="modal-adicionar" class="modal">
      <div class="modal-content" id="modal-content">
        <span class="fechar" onclick="fecharModalAdicionar()">&times;</span>
        
        <form method="post" action="{% url 'AdicionarProdu' %}">
          {% csrf_token %}
          <h1 style="color:black">Adicionar</h1>
          <br><br>


          <label for="tipo">Tipo:</label><br><br>
          <select id="tipo" name="tipo" required>
            <option value="" disabled selected>--Selecione um tipo--</option>
                <option value="Alimento" >Alimento</option>
                <option value="Ingresso">Ingresso</option>
                <option value="Roupa">Roupa</option>
          </select><br><br>


          <label for="nome">Nome do produto:</label><br><br>
          <input type="text" placeholder="Nome:" name="nome" id="nome" value="{{nome}}" required><br><br><br>

          <label for="cod_barras">Código de barras:</label><br><br>
          <input type="text" placeholder="cod_barras:" name="cod_barras" id="cod_barras" value ="{{cod_barras}}" minlength="4" required><br><br><br>
          {% if messages %}
                <script>
                  window.onload = function() {
                  exibirModalAdicionar();
                  };
              </script>
              {% for message in messages %}
              <h4{% if message.tags %} class="error-message" id ="error-mensagem" {% endif %}>{{message}}</h4>
              {% endfor %}
          {%endif%}
          <br>
          <label for="preco">Preço:</label><br><br>
          <input type="text"  placeholder="Preço:" name="preco" id="preco" onkeypress="validarEntrada(event)" value="{{preco}}" required><br><br><br>

          <br>


          <button type="submit">Adicionar produto</button>   
      </form>



      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>


      <script>
                $(document).ready(function () {
                    $('#cod_barras').inputmask('999-999999-999');
                });


        function exibirModalAdicionar() {
        var modal = document.getElementById("modal-adicionar");
        modal.style.display = "block";
        content = document.getElementById('modal-content')
        content.classList.add("modal-entrada");
        }

        function fecharModalAdicionar() {
        var modal = document.getElementById("modal-adicionar");
        modal.style.display = "none";
        window.location.href = "{% url 'VoltarProdutos'%}"
        }
        function validarEntrada(event) {
          var tecla = event.which || event.keyCode;
          if ((tecla < 48 || tecla > 57) && tecla != 46){
              event.preventDefault();
          }
      }
      const inputPreco = document.getElementById('preco');

      function formatarPreco(input) {
            let valor = input.value.replace(/\D/g, '');
            if (valor.length >= 3) {
                valor = valor.replace(/^(\d{1,})(\d{2})$/, '$1,$2');
            }
            input.value = 'R$ ' + valor;
        }

        inputPreco.addEventListener('focus', () => {
            if (!inputPreco.value) {
                inputPreco.value = 'R$ ';
            }
            floatingSpanPreco.style.transform = 'translateY(-8px) scale(0.6)';
            floatingSpanPreco.style.color = '#000';
        });

        inputPreco.addEventListener('blur', () => {
            if (!inputPreco.value) {
                floatingSpanPreco.style.transform = 'translateY(20px)';
                floatingSpanPreco.style.color = '#888';
            } else if (inputPreco.value === 'R$ ') {
                inputPreco.value = '';
                floatingSpanPreco.style.transform = 'translateY(20px)';
                floatingSpanPreco.style.color = '#888';
            }
        });

        inputPreco.addEventListener('input', () => {
            formatarPreco(inputPreco);
        });
      
      document.addEventListener('DOMContentLoaded', function() {
        var erro = document.getElementById('error-mensagem');
        erro.style.display = 'block';

        setTimeout(function() {
            erro.style.display = 'none';
        }, 3000);
        });
    </script>
</body>
</html>